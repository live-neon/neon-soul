---
created: 2026-02-07
completed: 2026-02-07
type: implementation-plan
status: Complete
language: typescript
code_examples: forbidden
review_principles: |
  1. No Code: Do NOT add code examples. Plans describe WHAT/WHY, not HOW.
  2. No Hardcoding: Do NOT add values that depend on implementation.
  3. Suggest Intent: File paths, interfaces, acceptance criteria instead.
  4. Flag, Don't Fix: If plan has code, flag for removal.
issue: docs/issues/cr6-twin-review-findings.md#TR-0
trigger: think hard
---

# Plan: Notation Simplification

## Problem Statement

The current notation generation architecture is over-engineered:

```
Principle text
  â†’ LLM maps to CJK vocabulary (21 constrained chars)
  â†’ LLM maps to emoji vocabulary (16 constrained emojis)
  â†’ Keyword matching for math notation
  â†’ Assemble canonical form with 4 fields
```

This creates unnecessary complexity:
- 3 separate mapping functions (`mapToCJKAnchor`, `mapToEmoji`, `generateMathNotation`)
- Constrained vocabularies that limit expression
- Keyword matching violates the proposal CRITICAL CONSTRAINT
- Extra LLM calls for vocabulary mapping

**Root cause**: The proposal described notation as a display format choice, but the implementation over-interpreted this as requiring constrained vocabulary classification.

**Solution**: Let the LLM generate both forms directly:
- Native form: Plain principle text
- Notated form: Principle with appropriate CJK/emoji/math notation

The LLM naturally chooses appropriate notation without artificial vocabulary constraints.

---

## Proposed Solution

### Before (Current)

```
CanonicalForm {
  emoji?: string     // From 16-emoji vocabulary
  cjk: string        // From 21-CJK vocabulary
  math: string       // From keyword matching
  native: string     // Plain text
}
```

### After (Simplified)

```
CanonicalForm {
  native: string     // Plain principle text
  notated: string    // With CJK/emoji/math as appropriate
}
```

The `notated` form is generated by a single LLM call that asks:
> "Express this principle with appropriate CJK anchor, emoji indicator, and mathematical notation if applicable."

This is simpler, more expressive, and eliminates keyword matching entirely.

---

## Stages

### Stage 0: Verify Current Usage

**Purpose**: Map all consumers of the mapping functions and CanonicalForm

**Files to check**:
- `src/lib/compressor.ts` - Uses mapToCJKAnchor, mapToEmoji, generateMathNotation
- `src/lib/semantic-classifier.ts` - Defines mapToCJKAnchor, mapToEmoji
- `src/lib/semantic-vocabulary.ts` - Defines CJK_ANCHORS, EMOJI_VOCABULARY
- `src/types/axiom.ts` - Defines CanonicalForm interface
- `tests/` - All tests using these functions

**Acceptance Criteria**:
- [ ] All consumers of mapping functions identified
- [ ] All consumers of CanonicalForm identified
- [ ] Impact on SOUL.md generation understood (generateSoulMd uses canonical.emoji/cjk/math)

**Commit**: `chore(neon-soul): verify notation simplification impact`

---

### Stage 1: Simplify CanonicalForm Interface

**File(s)**: `src/types/axiom.ts`

**Purpose**: Simplify the CanonicalForm interface

**Changes**:
- Change CanonicalForm to have only `native` and `notated` fields
- Add JSDoc explaining the two-form approach
- The `notated` field contains the full notation (CJK + emoji + math as appropriate)

**Acceptance Criteria**:
- [ ] CanonicalForm has exactly 2 fields: native, notated
- [ ] JSDoc explains the purpose of each field
- [ ] TypeScript compiles without errors

**Commit**: `refactor(neon-soul): simplify CanonicalForm to native/notated`

---

### Stage 2: Create generateNotatedForm Function

**File(s)**: `src/lib/compressor.ts`

**Purpose**: Replace 3 mapping functions with 1 generation function

**Changes**:
- Add `generateNotatedForm(llm, text)` function
- Single LLM call generates the notated form with CJK/emoji/math
- Prompt guides LLM to include appropriate notation naturally
- Remove import of mapToCJKAnchor, mapToEmoji from semantic-classifier

**Prompt design notes**:
- Ask LLM to express principle with CJK anchor + emoji + math notation
- Example output format: "ðŸŽ¯ èª : honesty > performance"
- LLM chooses appropriate symbols based on semantic meaning
- No constrained vocabulary - LLM selects naturally

**Acceptance Criteria**:
- [ ] `generateNotatedForm()` implemented
- [ ] Single LLM call generates full notation
- [ ] No keyword matching for math notation
- [ ] TypeScript compiles without errors

**Commit**: `feat(neon-soul): add generateNotatedForm with direct LLM generation`

---

### Stage 3: Update synthesizeAxiom

**File(s)**: `src/lib/compressor.ts`

**Purpose**: Use new generateNotatedForm in axiom synthesis

**Changes**:
- Replace parallel calls to mapToEmoji + mapToCJKAnchor with single generateNotatedForm call
- Remove generateMathNotation call
- Construct simplified CanonicalForm with native + notated

**Acceptance Criteria**:
- [ ] synthesizeAxiom uses generateNotatedForm
- [ ] No more mapToEmoji/mapToCJKAnchor/generateMathNotation usage
- [ ] Axioms have simplified CanonicalForm
- [ ] TypeScript compiles without errors

**Commit**: `refactor(neon-soul): use generateNotatedForm in synthesizeAxiom`

---

### Stage 4: Update generateSoulMd

**File(s)**: `src/lib/compressor.ts`

**Purpose**: Update SOUL.md generation for simplified CanonicalForm

**Changes**:
- Simplify format options: 'native' | 'notated' (was 4 options)
- 'native' format: Use canonical.native
- 'notated' format: Use canonical.notated
- Remove complex format assembly logic

**Acceptance Criteria**:
- [ ] generateSoulMd accepts 'native' | 'notated' format
- [ ] Both formats render correctly
- [ ] TypeScript compiles without errors

**Commit**: `refactor(neon-soul): simplify generateSoulMd format options`

---

### Stage 5: Remove Mapping Functions from semantic-classifier.ts

**File(s)**: `src/lib/semantic-classifier.ts`

**Purpose**: Remove vocabulary mapping functions

**Changes**:
- Remove `mapToCJKAnchor()` function (~40 lines)
- Remove `mapToEmoji()` function (~40 lines)
- Remove imports/exports related to CJK_ANCHORS, EMOJI_VOCABULARY
- Update module docstring to remove these functions from list

**Acceptance Criteria**:
- [ ] mapToCJKAnchor removed
- [ ] mapToEmoji removed
- [ ] Module has 4 functions (was 6)
- [ ] File size reduced by ~80-100 lines
- [ ] TypeScript compiles without errors

**Commit**: `refactor(neon-soul): remove vocabulary mapping functions`

---

### Stage 6: Remove Vocabularies from semantic-vocabulary.ts

**File(s)**: `src/lib/semantic-vocabulary.ts`

**Purpose**: Remove constrained vocabulary definitions

**Changes**:
- Remove `CJK_ANCHORS` constant (21 entries)
- Remove `EMOJI_VOCABULARY` constant (16 entries)
- Keep SIGNAL_TYPES, SECTION_TYPES, MEMORY_CATEGORIES (still needed)
- Keep SOULCRAFT_DIMENSIONS export (still needed)

**Acceptance Criteria**:
- [ ] CJK_ANCHORS removed
- [ ] EMOJI_VOCABULARY removed
- [ ] Remaining vocabularies intact
- [ ] TypeScript compiles without errors

**Commit**: `refactor(neon-soul): remove CJK/emoji vocabulary constraints`

---

### Stage 7: Update Tests

**File(s)**:
- `tests/unit/semantic-classifier.test.ts`
- `tests/unit/compressor.test.ts`
- `tests/mocks/llm-mock.ts`

**Purpose**: Update tests for simplified architecture

**Changes**:
- Remove tests for mapToCJKAnchor, mapToEmoji
- Add tests for generateNotatedForm
- Update mock LLM to handle notation generation prompts
- Update compressor tests for simplified CanonicalForm
- Remove createMockLLMWithCanonicalMapping (no longer needed)

**Acceptance Criteria**:
- [ ] No tests reference removed functions
- [ ] New tests for generateNotatedForm
- [ ] All tests pass
- [ ] Test count may decrease (removing vocabulary tests)

**Commit**: `test(neon-soul): update tests for notation simplification`

---

### Stage 8: Verify and Clean Up

**Purpose**: Final verification and cleanup

**Files to verify**:
- No imports of mapToCJKAnchor, mapToEmoji, generateMathNotation
- No references to CJK_ANCHORS, EMOJI_VOCABULARY
- CanonicalForm has only 2 fields everywhere

**Acceptance Criteria**:
- [ ] grep for removed functions returns 0 results
- [ ] grep for removed vocabularies returns 0 results
- [ ] All tests pass
- [ ] TypeScript compiles without errors
- [ ] File sizes reduced (semantic-classifier.ts should be ~200 lines now)

**Commit**: `chore(neon-soul): verify notation simplification complete`

---

## Rollback Plan

If issues arise after implementation:

1. **Immediate**: Revert to previous commit using git
2. **LLM quality issues**: If LLM generates poor notation, can add prompt refinement
3. **Format compatibility**: Old axioms with 4-field CanonicalForm need migration script

**Migration for existing data**:
- Read old axioms with 4 fields
- Reconstruct notated form: `${emoji} ${cjk}: ${math}` â†’ notated
- Save with 2-field format

---

## Success Criteria

1. CanonicalForm has exactly 2 fields (native, notated)
2. Zero vocabulary mapping functions in codebase
3. Zero keyword matching for notation (`.includes()` eliminated)
4. Single LLM call generates notated form
5. SOUL.md generation works with simplified format
6. All tests pass
7. semantic-classifier.ts under 200 lines (MCE compliance)
8. TR-0, TR-1, TR-8 resolved in issue

---

## Benefits

1. **Simpler architecture**: 1 function instead of 3
2. **More expressive**: LLM chooses natural notation, no vocabulary constraints
3. **CRITICAL CONSTRAINT compliance**: No keyword matching for semantic interpretation
4. **Fewer LLM calls**: 1 call instead of 2 (was mapToEmoji + mapToCJKAnchor)
5. **Smaller codebase**: ~150 lines removed
6. **MCE compliance**: semantic-classifier.ts under 200 lines

---

## Related

- **Triggering Issue**: `docs/issues/cr6-twin-review-findings.md#TR-0` (TR-0 architectural simplification)
- **Parent Issue**: `docs/issues/neon-soul-implementation-code-review-findings.md#CR-6` (CR-6 semantic classification)
- **Prior Plan**: `docs/plans/2026-02-07-cr6-semantic-classification-refactor.md` (CR-6 refactor that this simplifies)
- **Proposal**: `docs/proposals/soul-bootstrap-pipeline-proposal.md` (notation format section)
